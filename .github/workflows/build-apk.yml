name: ðŸš€ Build Enhanced uHabits APK

on:
  push:
    branches: [ main, dev, master ]
  pull_request:
    branches: [ main, dev, master ]
  workflow_dispatch:  # Allow manual trigger
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release

jobs:
  build:
    name: ðŸ—ï¸ Build Enhanced uHabits
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ðŸ”‘ Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: ðŸ“± Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: ðŸ”§ Validate Gradle Wrapper
      uses: gradle/wrapper-validation-action@v1

    - name: ðŸ“‹ Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: ðŸ§¹ Clean project
      run: ./gradlew clean

    - name: ðŸ” Check project structure
      run: |
        echo "ðŸ“ Project structure:"
        ls -la
        echo "ðŸ“ Android module:"
        ls -la uhabits-android/
        echo "ðŸ“ Core module:"
        ls -la uhabits-core/

    - name: ðŸ”¨ Build Debug APK
      if: github.event.inputs.build_type != 'release'
      run: |
        echo "ðŸ”¨ Building debug APK..."
        ./gradlew :uhabits-android:assembleDebug --stacktrace --info
        
    - name: ðŸ”¨ Build Release APK
      if: github.event.inputs.build_type == 'release' || github.ref == 'refs/heads/main'
      run: |
        echo "ðŸ”¨ Building release APK..."
        ./gradlew :uhabits-android:assembleRelease --stacktrace --info

    - name: ðŸ“Š Get APK info
      run: |
        echo "ðŸ” Checking for APK files..."
        find . -name "*.apk" -type f
        
        if [ -f "uhabits-android/build/outputs/apk/debug/uhabits-android-debug.apk" ]; then
          echo "ðŸ“± Debug APK size: $(du -h uhabits-android/build/outputs/apk/debug/uhabits-android-debug.apk | cut -f1)"
          echo "ðŸ“ Debug APK path: uhabits-android/build/outputs/apk/debug/uhabits-android-debug.apk"
        fi
        if [ -f "uhabits-android/build/outputs/apk/release/uhabits-android-release-unsigned.apk" ]; then
          echo "ðŸ“± Release APK size: $(du -h uhabits-android/build/outputs/apk/release/uhabits-android-release-unsigned.apk | cut -f1)"
          echo "ðŸ“ Release APK path: uhabits-android/build/outputs/apk/release/uhabits-android-release-unsigned.apk"
        fi

    - name: ðŸ·ï¸ Generate build info
      run: |
        echo "# ðŸš€ Enhanced uHabits Build Information" > build-info.md
        echo "" >> build-info.md
        echo "**Build Date:** $(date)" >> build-info.md
        echo "**Commit:** ${{ github.sha }}" >> build-info.md
        echo "**Branch:** ${{ github.ref_name }}" >> build-info.md
        echo "**Triggered by:** ${{ github.event_name }}" >> build-info.md
        echo "" >> build-info.md
        echo "## ðŸŽ¯ Enhanced Features Included:" >> build-info.md
        echo "- âœ… 100-point scoring system" >> build-info.md
        echo "- âœ… Advanced analytics engine" >> build-info.md
        echo "- âœ… PowerBI/Looker Studio export" >> build-info.md
        echo "- âœ… Habit correlation analysis" >> build-info.md
        echo "- âœ… Weekly/Monthly performance tracking" >> build-info.md
        echo "- âœ… Professional analytics UI" >> build-info.md
        echo "" >> build-info.md
        echo "## ðŸ“± Installation:" >> build-info.md
        echo "1. Download the APK file" >> build-info.md
        echo "2. Enable 'Unknown sources' on your Android device" >> build-info.md
        echo "3. Install the APK" >> build-info.md
        echo "4. Look for 'Advanced Analytics' in the menu!" >> build-info.md

    - name: ðŸ“¦ Upload Debug APK
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: enhanced-uhabits-debug-${{ github.run_number }}
        path: |
          uhabits-android/build/outputs/apk/debug/*.apk
          build-info.md
        retention-days: 30
        if-no-files-found: warn

    - name: ðŸ“¦ Upload Release APK
      if: github.event.inputs.build_type == 'release' || github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: enhanced-uhabits-release-${{ github.run_number }}
        path: |
          uhabits-android/build/outputs/apk/release/*.apk
          build-info.md
        retention-days: 90
        if-no-files-found: warn

    - name: ðŸŽ‰ Build Summary
      run: |
        echo "ðŸŽ‰ Enhanced uHabits build completed successfully!"
        echo ""
        echo "ðŸ“‹ Build Summary:"
        echo "================="
        echo "âœ… Repository: ${{ github.repository }}"
        echo "âœ… Branch: ${{ github.ref_name }}"
        echo "âœ… Commit: ${{ github.sha }}"
        echo "âœ… Build triggered by: ${{ github.event_name }}"
        echo ""
        echo "ðŸŽ¯ Enhanced Features:"
        echo "â€¢ 100-point scoring system (instead of 0-1)"
        echo "â€¢ Advanced analytics dashboard"
        echo "â€¢ PowerBI/Looker Studio data export"
        echo "â€¢ Habit correlation analysis"
        echo "â€¢ Weekly/Monthly performance tracking"
        echo "â€¢ Professional UI with progress indicators"
        echo ""
        echo "ðŸ“± APK files are available in the Actions artifacts!"
        echo "ðŸ’¡ Download and install on your Samsung phone to test."
