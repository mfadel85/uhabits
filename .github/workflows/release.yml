name: ðŸŽ‰ Release Enhanced uHabits

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.1.0, etc.
  workflow_dispatch:  # Allow manual release
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

jobs:
  release:
    name: ðŸš€ Create Release
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ðŸ˜ Setup Gradle
      uses: gradle/gradle-build-action@v2

    - name: ðŸ“± Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 36
        target: google_apis
        arch: x86_64

    - name: ðŸ”‘ Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: ðŸ“‹ Grant execute permission for gradlew
      run: |
        cd uhabits
        chmod +x gradlew

    - name: ðŸ”¨ Build Release APK
      run: |
        cd uhabits
        ./gradlew clean
        ./gradlew :uhabits-android:assembleRelease

    - name: ðŸ·ï¸ Get version
      id: version
      run: |
        if [ "${{ github.event.inputs.version }}" != "" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ“ Generate Release Notes
      run: |
        cat > release-notes.md << 'EOF'
        # ðŸš€ Enhanced uHabits with Advanced Analytics
        
        ## ðŸŽ¯ What's New in This Release
        
        ### ðŸ“Š Advanced Analytics System
        - **100-Point Scoring**: Intuitive 0-100 scoring instead of 0-1 scale
        - **Multi-Timeframe Analysis**: Daily, weekly, and monthly performance metrics
        - **Trend Detection**: Automatic identification of improving/declining patterns
        - **Streak Bonuses**: Extra points for consistent habit maintenance
        
        ### ðŸ”— Business Intelligence Integration
        - **PowerBI Export**: CSV format optimized for Microsoft PowerBI
        - **Looker Studio Support**: JSON export for Google's BI platform
        - **Custom Analytics**: Comprehensive data export for any BI tool
        
        ### ðŸŽ¨ Enhanced User Interface
        - **Professional Dashboard**: Tab-based analytics interface
        - **Progress Indicators**: Circular progress bars with 0-100 scores
        - **Trend Arrows**: Visual indicators for performance direction
        - **Correlation Analysis**: Discover relationships between habits
        
        ### ðŸ“ˆ Performance Insights
        - **Consistency Scoring**: Measure habit regularity
        - **Velocity Tracking**: Rate of improvement/decline
        - **Performance Categories**: Excellent, Good, Average, Poor ratings
        - **Maturity Bonuses**: Extra points for long-established habits
        
        ## ðŸ“± Installation Instructions
        
        ### Samsung/Android Devices:
        1. **Download** the `enhanced-uhabits-release.apk` file below
        2. **Enable Unknown Sources**: Settings â†’ Apps â†’ Special Access â†’ Install Unknown Apps
        3. **Install APK**: Tap the downloaded file and follow prompts
        4. **Launch**: Open "Loop Habit Tracker"
        5. **Access Analytics**: Tap menu (â‹®) â†’ "Advanced Analytics"
        
        ### First-Time Setup:
        - Create or import your existing habits
        - Use the app for a few days to generate analytics data
        - Export data to PowerBI/Looker Studio for advanced dashboards
        
        ## ðŸ”§ Technical Details
        
        - **Android Version**: Requires Android 7.0+ (API 28+)
        - **Permissions**: Same as original uHabits (no additional permissions)
        - **Size**: ~8-10MB (similar to original)
        - **Compatibility**: Works with existing uHabits data
        
        ## ðŸŽ¯ Business Intelligence Setup
        
        ### PowerBI Integration:
        1. Export data from app: Menu â†’ Advanced Analytics â†’ Export â†’ PowerBI Dataset
        2. Import CSV files into PowerBI Desktop
        3. Create relationships between habit_metadata.csv and daily_scores.csv
        4. Build visualizations using 0-100 scoring system
        
        ### Looker Studio Integration:
        1. Export data: Menu â†’ Advanced Analytics â†’ Export â†’ Looker Studio
        2. Create new report in Looker Studio
        3. Upload the JSON file as data source
        4. Use ScoreCategory field for color-coded visualizations
        
        ## ðŸ› Known Issues
        - None currently reported
        
        ## ðŸ’¡ Tips for Best Results
        - Use the app consistently for at least a week to see meaningful analytics
        - Export data weekly/monthly for trend analysis in BI tools
        - Check correlation analysis to discover habit relationships
        
        ---
        
        **Built with â¤ï¸ by mfadel85**
        
        *Based on the excellent Loop Habit Tracker by Ãlinson Santos Xavier*
        EOF

    - name: ðŸ“¦ Prepare Release Assets
      run: |
        cd uhabits
        mkdir -p release-assets
        
        # Copy APK with better name
        if [ -f "uhabits-android/build/outputs/apk/release/uhabits-android-release-unsigned.apk" ]; then
          cp "uhabits-android/build/outputs/apk/release/uhabits-android-release-unsigned.apk" "release-assets/enhanced-uhabits-${{ steps.version.outputs.version }}.apk"
        fi
        
        # Create installation guide
        cat > release-assets/INSTALLATION-GUIDE.txt << 'EOF'
        ðŸ“± Enhanced uHabits - Installation Guide
        =====================================
        
        ðŸš€ Quick Start:
        1. Download enhanced-uhabits-vX.X.X.apk
        2. Enable "Install from Unknown Sources" on your Android device
        3. Install the APK file
        4. Open "Loop Habit Tracker"
        5. Look for "Advanced Analytics" in the menu!
        
        ðŸŽ¯ New Features:
        â€¢ 100-point scoring system
        â€¢ Advanced analytics dashboard  
        â€¢ PowerBI/Looker Studio export
        â€¢ Habit correlation analysis
        â€¢ Weekly/monthly performance tracking
        
        ðŸ’¡ For detailed setup instructions, see the release notes.
        EOF
        
        # Create BI integration guide
        cat > release-assets/BI-INTEGRATION-GUIDE.txt << 'EOF'
        ðŸ“Š Business Intelligence Integration Guide
        ========================================
        
        ðŸŽ¯ Your Enhanced uHabits now supports professional BI tools!
        
        ðŸ“¤ Data Export:
        1. Open Enhanced uHabits
        2. Menu â†’ Advanced Analytics
        3. Menu â†’ Export Data
        4. Choose format: PowerBI (CSV) or Looker Studio (JSON)
        
        ðŸ“ˆ PowerBI Setup:
        1. Open PowerBI Desktop
        2. Get Data â†’ Text/CSV
        3. Import daily_scores.csv and habit_metadata.csv
        4. Create relationships between tables
        5. Build dashboards with 0-100 scoring
        
        ðŸ“Š Looker Studio Setup:
        1. Open Looker Studio
        2. Create New Report
        3. Add Data Source â†’ File Upload
        4. Upload exported JSON file
        5. Create time-series visualizations
        
        ðŸŽ¨ Suggested Charts:
        â€¢ Line charts: Daily scores over time
        â€¢ Bar charts: Average scores by habit
        â€¢ Heat maps: Weekly patterns
        â€¢ Trend indicators: Performance direction
        EOF

    - name: ðŸŽ‰ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: "Enhanced uHabits ${{ steps.version.outputs.version }} - Advanced Analytics"
        body_path: release-notes.md
        prerelease: ${{ github.event.inputs.prerelease }}
        files: |
          uhabits/release-assets/*
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“¢ Release Summary
      run: |
        echo "ðŸŽ‰ Enhanced uHabits ${{ steps.version.outputs.version }} released successfully!"
        echo ""
        echo "ðŸ“‹ Release Details:"
        echo "=================="
        echo "âœ… Version: ${{ steps.version.outputs.version }}"
        echo "âœ… Repository: ${{ github.repository }}"
        echo "âœ… Commit: ${{ github.sha }}"
        echo "âœ… Pre-release: ${{ github.event.inputs.prerelease }}"
        echo ""
        echo "ðŸ“± Release includes:"
        echo "â€¢ Enhanced uHabits APK with 100-point scoring"
        echo "â€¢ Installation guide"
        echo "â€¢ Business Intelligence integration guide"
        echo ""
        echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
